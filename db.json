const fs = require('fs-extra');
const path = require('path');

const DATA_FILE = path.join(__dirname, 'db.json');
const CLICK_REWARD = 0.0005;
const REF_REWARD = 0.01;
const WITHDRAW_LIMIT = 0.10;
const ADMIN_ID = 6136849497;
const CHANNELS = ['@freeclaimltc', '@Konnetearnchannel'];

// Load DB or create default structure
let db = fs.existsSync(DATA_FILE)
  ? fs.readJsonSync(DATA_FILE)
  : { users: {} };

// Save changes to disk
function saveDB() {
  fs.writeJsonSync(DATA_FILE, db);
}

// Get or create user
function getUser(id) {
  if (!db.users[id]) {
    db.users[id] = {
      balance: 0,
      referrals: [],
      clicks: [],
      joined: false
    };
    saveDB();
  }
  return db.users[id];
}

// Add to user balance
function creditUser(id, amount) {
  const user = getUser(id);
  user.balance += amount;
  saveDB();
}

// Subtract from user balance
function debitUser(id, amount) {
  const user = getUser(id);
  user.balance = Math.max(0, user.balance - amount);
  saveDB();
}

// Record click timestamp
function logClick(id) {
  const user = getUser(id);
  user.clicks.push(Date.now());
  saveDB();
}

// Add referral
function addReferral(referrerId, referredId) {
  const refUser = getUser(referrerId);
  if (!refUser.referrals.includes(referredId)) {
    refUser.referrals.push(referredId);
    refUser.balance += REF_REWARD;
    saveDB();
    return true;
  }
  return false;
}

// Export all functions and constants
module.exports = {
  getUser,
  creditUser,
  debitUser,
  logClick,
  addReferral,
  saveDB,
  DATA_FILE,
  CLICK_REWARD,
  REF_REWARD,
  WITHDRAW_LIMIT,
  ADMIN_ID,
  CHANNELS,
  db
};
